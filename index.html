<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WCA ä¸‰é˜¶æœ€å°‘æ­¥ (333fm) ç»Ÿè®¡æ•°æ®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #555;
        }

        .control-group select,
        .control-group input,
        .control-group button {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
            cursor: pointer;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .control-group button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .column-selector {
            position: relative;
        }

        .column-selector-panel {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 10px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            min-width: 400px;
            display: none;
        }

        .column-selector-panel.show {
            display: block;
        }

        .column-category {
            margin-bottom: 20px;
        }

        .column-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .column-category h4 {
            margin: 0;
            color: #667eea;
            font-size: 1em;
        }

        .category-actions {
            display: flex;
            gap: 8px;
        }

        .category-actions button {
            padding: 4px 12px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .category-actions button:hover {
            background: #667eea;
            color: white;
        }

        .column-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }

        .column-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .column-checkbox label {
            cursor: pointer;
            font-weight: normal;
            font-size: 0.9em;
        }

        .column-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .column-actions button {
            flex: 1;
            padding: 8px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .column-actions button:hover {
            background: #667eea;
            color: white;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #666;
            font-size: 0.9em;
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        th:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        th.sortable::after {
            content: ' â†•';
            opacity: 0.5;
            font-size: 0.8em;
        }

        th.sort-asc::after {
            content: ' â†‘';
            opacity: 1;
        }

        th.sort-desc::after {
            content: ' â†“';
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f5f5f5;
        }

        tbody tr:nth-child(even) {
            background: #fafafa;
        }

        tbody tr:nth-child(even):hover {
            background: #f0f0f0;
        }

        td {
            padding: 12px 10px;
            white-space: nowrap;
        }

        .number {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .rank {
            font-weight: bold;
            color: #667eea;
        }

        .medal-gold {
            color: #ffd700;
            font-weight: bold;
        }

        .medal-silver {
            color: #c0c0c0;
            font-weight: bold;
        }

        .medal-bronze {
            color: #cd7f32;
            font-weight: bold;
        }

        .pagination {
            padding: 20px 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
        }

        .pagination button {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            padding: 10px 20px;
            font-weight: 600;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ† WCA ä¸‰é˜¶æœ€å°‘æ­¥ (333fm) ç»Ÿè®¡æ•°æ®</h1>
            <p id="headerDescription">ä¸­å›½é€‰æ‰‹ Top 30 æ’è¡Œæ¦œ</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="fileSelect">æ•°æ®æ–‡ä»¶:</label>
                <select id="fileSelect">
                    <option value="results.china.top30.csv">ä¸­å›½ Top 30</option>
                    <option value="results.top100.csv">å…¨çƒ Top 100</option>
                    <option value="results.csv">å®Œæ•´æ•°æ®</option>
                </select>
            </div>
            <div class="control-group">
                <label for="sortColumn">æ’åºå­—æ®µ:</label>
                <select id="sortColumn">
                    <option value="best_rank">æœ€ä½³æˆç»©æ’å</option>
                    <option value="average_rank">å¹³å‡æˆç»©æ’å</option>
                    <option value="solved_mean_rank">å•æ¬¡å¹³å‡æ’å</option>
                    <option value="best">æœ€ä½³æˆç»©</option>
                    <option value="average">å¹³å‡æˆç»©</option>
                    <option value="solved_mean">å•æ¬¡å¹³å‡</option>
                    <option value="competitions">æ¯”èµ›æ¬¡æ•°</option>
                    <option value="rounds">è½®æ¬¡</option>
                </select>
            </div>
            <div class="control-group">
                <label for="sortOrder">æ’åºæ–¹å¼:</label>
                <select id="sortOrder">
                    <option value="asc">å‡åº</option>
                    <option value="desc">é™åº</option>
                </select>
            </div>
            <div class="control-group">
                <label for="searchInput">æœç´¢:</label>
                <input type="text" id="searchInput" placeholder="è¾“å…¥å§“åæœç´¢...">
            </div>
            <div class="control-group column-selector">
                <button id="columnSelectorBtn">é€‰æ‹©åˆ—...</button>
                <div class="column-selector-panel" id="columnSelectorPanel">
                    <div id="columnCheckboxes"></div>
                    <div class="column-actions">
                        <button id="selectAllBtn">å…¨é€‰</button>
                        <button id="selectNoneBtn">å…¨ä¸é€‰</button>
                        <button id="selectDefaultBtn">é»˜è®¤</button>
                        <button id="applyColumnsBtn">åº”ç”¨</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-summary" id="statsSummary">
            <div class="stat-card">
                <div class="value" id="totalPlayers">-</div>
                <div class="label">æ€»é€‰æ‰‹æ•°</div>
            </div>
            <div class="stat-card">
                <div class="value" id="avgBest">-</div>
                <div class="label">å¹³å‡æœ€ä½³æˆç»©</div>
            </div>
            <div class="stat-card">
                <div class="value" id="avgAverage">-</div>
                <div class="label">å¹³å‡æˆç»©</div>
            </div>
            <div class="stat-card">
                <div class="value" id="totalCompetitions">-</div>
                <div class="label">æ€»æ¯”èµ›æ¬¡æ•°</div>
            </div>
        </div>

        <div class="table-container">
            <div id="loading" class="loading">åŠ è½½æ•°æ®ä¸­...</div>
            <div id="error" class="error" style="display: none;"></div>
            <table id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th class="sortable" data-column="personName">å§“å</th>
                        <th class="sortable number" data-column="best">æœ€ä½³</th>
                        <th class="sortable number" data-column="best_rank">æœ€ä½³æ’å</th>
                        <th class="sortable number" data-column="average">å¹³å‡</th>
                        <th class="sortable number" data-column="average_rank">å¹³å‡æ’å</th>
                        <th class="sortable number" data-column="solved_mean">å•æ¬¡å¹³å‡</th>
                        <th class="sortable number" data-column="solved_mean_rank">å•æ¬¡æ’å</th>
                        <th class="sortable number" data-column="competitions">æ¯”èµ›</th>
                        <th class="sortable number" data-column="rounds">è½®æ¬¡</th>
                        <th class="sortable number" data-column="solved_count">æˆåŠŸæ¬¡æ•°</th>
                        <th class="sortable number" data-column="gold">ğŸ¥‡</th>
                        <th class="sortable number" data-column="silver">ğŸ¥ˆ</th>
                        <th class="sortable number" data-column="bronze">ğŸ¥‰</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <div class="pagination" id="pagination" style="display: none;">
            <button id="prevPage">ä¸Šä¸€é¡µ</button>
            <div class="page-info" id="pageInfo">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</div>
            <button id="nextPage">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 30;
        let sortColumn = 'best_rank';
        let sortOrder = 'asc';
        let allHeaders = [];
        let visibleColumns = [];
        let currentFile = 'results.china.top30.csv';
        
        // æ–‡ä»¶é…ç½®
        const fileConfigs = {
            'results.china.top30.csv': {
                name: 'ä¸­å›½ Top 30',
                description: 'ä¸­å›½é€‰æ‰‹ Top 30 æ’è¡Œæ¦œ'
            },
            'results.top100.csv': {
                name: 'å…¨çƒ Top 100',
                description: 'å…¨çƒ Top 100 æ’è¡Œæ¦œ'
            },
            'results.csv': {
                name: 'å®Œæ•´æ•°æ®',
                description: 'å®Œæ•´ç»Ÿè®¡æ•°æ®ï¼ˆæ‰€æœ‰é€‰æ‰‹ï¼‰'
            }
        };
        
        // åˆ—å®šä¹‰ï¼ˆæŒ‰ç±»åˆ«ç»„ç»‡ï¼‰
        const columnDefinitions = {
            'åŸºæœ¬ä¿¡æ¯': [
                { key: 'personName', label: 'å§“å' },
                { key: 'personId', label: 'ID' },
                { key: 'countryId', label: 'å›½å®¶' },
                { key: 'gender', label: 'æ€§åˆ«' }
            ],
            'æ¯”èµ›ç»Ÿè®¡': [
                { key: 'competitions', label: 'æ¯”èµ›æ¬¡æ•°' },
                { key: 'rounds', label: 'è½®æ¬¡' },
                { key: 'chances', label: 'æœºä¼šæ•°' },
                { key: 'attempts', label: 'å°è¯•æ¬¡æ•°' }
            ],
            'æœ€ä½³æˆç»©': [
                { key: 'best', label: 'æœ€ä½³' },
                { key: 'best_max', label: 'æœ€ä½³æœ€å¤§å€¼' },
                { key: 'best_count', label: 'æœ€ä½³æ¬¡æ•°' },
                { key: 'best_nunique', label: 'æœ€ä½³å”¯ä¸€å€¼æ•°' },
                { key: 'best_mean', label: 'æœ€ä½³å¹³å‡' },
                { key: 'best_std', label: 'æœ€ä½³æ ‡å‡†å·®' },
                { key: 'best_avg', label: 'æœ€ä½³å¹³å‡(å»æå€¼)' },
                { key: 'best_median', label: 'æœ€ä½³ä¸­ä½æ•°' },
                { key: 'best_mode', label: 'æœ€ä½³ä¼—æ•°' },
                { key: 'best_mode_count', label: 'æœ€ä½³ä¼—æ•°æ¬¡æ•°' },
                { key: 'best_consecutive', label: 'æœ€ä½³è¿ç»­æ¬¡æ•°' },
                { key: 'best_consecutive_start', label: 'æœ€ä½³è¿ç»­å¼€å§‹' },
                { key: 'best_consecutive_end', label: 'æœ€ä½³è¿ç»­ç»“æŸ' }
            ],
            'å¹³å‡æˆç»©': [
                { key: 'average', label: 'å¹³å‡' },
                { key: 'average_max', label: 'å¹³å‡æœ€å¤§å€¼' },
                { key: 'average_count', label: 'å¹³å‡æ¬¡æ•°' },
                { key: 'average_nunique', label: 'å¹³å‡å”¯ä¸€å€¼æ•°' },
                { key: 'average_mean', label: 'å¹³å‡å‡å€¼' },
                { key: 'average_std', label: 'å¹³å‡æ ‡å‡†å·®' },
                { key: 'average_avg', label: 'å¹³å‡(å»æå€¼)' },
                { key: 'average_median', label: 'å¹³å‡ä¸­ä½æ•°' },
                { key: 'average_mode', label: 'å¹³å‡ä¼—æ•°' },
                { key: 'average_mode_count', label: 'å¹³å‡ä¼—æ•°æ¬¡æ•°' },
                { key: 'average_consecutive', label: 'å¹³å‡è¿ç»­æ¬¡æ•°' },
                { key: 'average_consecutive_start', label: 'å¹³å‡è¿ç»­å¼€å§‹' },
                { key: 'average_consecutive_end', label: 'å¹³å‡è¿ç»­ç»“æŸ' },
                { key: 'average_attempts', label: 'å¹³å‡å°è¯•æ¬¡æ•°' }
            ],
            'å•æ¬¡æˆç»©': [
                { key: 'solved_count', label: 'æˆåŠŸæ¬¡æ•°' },
                { key: 'solved_nunique', label: 'æˆåŠŸå”¯ä¸€å€¼æ•°' },
                { key: 'solved_mean', label: 'å•æ¬¡å¹³å‡' },
                { key: 'solved_std', label: 'å•æ¬¡æ ‡å‡†å·®' },
                { key: 'solved_avg', label: 'å•æ¬¡å¹³å‡(å»æå€¼)' },
                { key: 'solved_median', label: 'å•æ¬¡ä¸­ä½æ•°' },
                { key: 'solved_mode', label: 'å•æ¬¡ä¼—æ•°' },
                { key: 'solved_mode_count', label: 'å•æ¬¡ä¼—æ•°æ¬¡æ•°' },
                { key: 'solved_min', label: 'å•æ¬¡æœ€å°å€¼' },
                { key: 'solved_max', label: 'å•æ¬¡æœ€å¤§å€¼' },
                { key: 'solved_consecutive', label: 'å•æ¬¡è¿ç»­æ¬¡æ•°' },
                { key: 'solved_consecutive_start', label: 'å•æ¬¡è¿ç»­å¼€å§‹' },
                { key: 'solved_consecutive_end', label: 'å•æ¬¡è¿ç»­ç»“æŸ' }
            ],
            'æ»šåŠ¨å¹³å‡ - MO': [
                { key: 'solved_mo3_last', label: 'MO3 æœ€å' },
                { key: 'solved_mo3_best', label: 'MO3 æœ€ä½³' },
                { key: 'solved_mo5_last', label: 'MO5 æœ€å' },
                { key: 'solved_mo5_best', label: 'MO5 æœ€ä½³' },
                { key: 'solved_mo12_last', label: 'MO12 æœ€å' },
                { key: 'solved_mo12_best', label: 'MO12 æœ€ä½³' },
                { key: 'solved_mo50_last', label: 'MO50 æœ€å' },
                { key: 'solved_mo50_best', label: 'MO50 æœ€ä½³' },
                { key: 'solved_mo100_last', label: 'MO100 æœ€å' },
                { key: 'solved_mo100_best', label: 'MO100 æœ€ä½³' }
            ],
            'æ»šåŠ¨å¹³å‡ - AO': [
                { key: 'solved_ao5_last', label: 'AO5 æœ€å' },
                { key: 'solved_ao5_best', label: 'AO5 æœ€ä½³' },
                { key: 'solved_ao12_last', label: 'AO12 æœ€å' },
                { key: 'solved_ao12_best', label: 'AO12 æœ€ä½³' },
                { key: 'solved_ao50_last', label: 'AO50 æœ€å' },
                { key: 'solved_ao50_best', label: 'AO50 æœ€ä½³' },
                { key: 'solved_ao100_last', label: 'AO100 æœ€å' },
                { key: 'solved_ao100_best', label: 'AO100 æœ€ä½³' }
            ],
            'å¥–ç‰Œ': [
                { key: 'gold', label: 'ğŸ¥‡ é‡‘ç‰Œ' },
                { key: 'silver', label: 'ğŸ¥ˆ é“¶ç‰Œ' },
                { key: 'bronze', label: 'ğŸ¥‰ é“œç‰Œ' }
            ],
            'å…¨çƒæ’å': [
                { key: 'best_rank', label: 'æœ€ä½³æ’å' },
                { key: 'best_max_rank', label: 'æœ€ä½³æœ€å¤§æ’å' },
                { key: 'best_count_rank', label: 'æœ€ä½³æ¬¡æ•°æ’å' },
                { key: 'best_nunique_rank', label: 'æœ€ä½³å”¯ä¸€å€¼æ•°æ’å' },
                { key: 'best_mean_rank', label: 'æœ€ä½³å¹³å‡æ’å' },
                { key: 'best_std_rank', label: 'æœ€ä½³æ ‡å‡†å·®æ’å' },
                { key: 'best_avg_rank', label: 'æœ€ä½³å¹³å‡(å»æå€¼)æ’å' },
                { key: 'best_median_rank', label: 'æœ€ä½³ä¸­ä½æ•°æ’å' },
                { key: 'best_mode_rank', label: 'æœ€ä½³ä¼—æ•°æ’å' },
                { key: 'best_mode_count_rank', label: 'æœ€ä½³ä¼—æ•°æ¬¡æ•°æ’å' },
                { key: 'best_consecutive_rank', label: 'æœ€ä½³è¿ç»­æ¬¡æ•°æ’å' },
                { key: 'best_consecutive_start_rank', label: 'æœ€ä½³è¿ç»­å¼€å§‹æ’å' },
                { key: 'best_consecutive_end_rank', label: 'æœ€ä½³è¿ç»­ç»“æŸæ’å' },
                { key: 'average_rank', label: 'å¹³å‡æ’å' },
                { key: 'average_max_rank', label: 'å¹³å‡æœ€å¤§æ’å' },
                { key: 'average_count_rank', label: 'å¹³å‡æ¬¡æ•°æ’å' },
                { key: 'average_nunique_rank', label: 'å¹³å‡å”¯ä¸€å€¼æ•°æ’å' },
                { key: 'average_mean_rank', label: 'å¹³å‡å‡å€¼æ’å' },
                { key: 'average_std_rank', label: 'å¹³å‡æ ‡å‡†å·®æ’å' },
                { key: 'average_avg_rank', label: 'å¹³å‡(å»æå€¼)æ’å' },
                { key: 'average_median_rank', label: 'å¹³å‡ä¸­ä½æ•°æ’å' },
                { key: 'average_mode_rank', label: 'å¹³å‡ä¼—æ•°æ’å' },
                { key: 'average_mode_count_rank', label: 'å¹³å‡ä¼—æ•°æ¬¡æ•°æ’å' },
                { key: 'average_consecutive_rank', label: 'å¹³å‡è¿ç»­æ¬¡æ•°æ’å' },
                { key: 'average_consecutive_start_rank', label: 'å¹³å‡è¿ç»­å¼€å§‹æ’å' },
                { key: 'average_consecutive_end_rank', label: 'å¹³å‡è¿ç»­ç»“æŸæ’å' },
                { key: 'average_attempts_rank', label: 'å¹³å‡å°è¯•æ¬¡æ•°æ’å' },
                { key: 'solved_count_rank', label: 'æˆåŠŸæ¬¡æ•°æ’å' },
                { key: 'solved_nunique_rank', label: 'æˆåŠŸå”¯ä¸€å€¼æ•°æ’å' },
                { key: 'solved_mean_rank', label: 'å•æ¬¡å¹³å‡æ’å' },
                { key: 'solved_std_rank', label: 'å•æ¬¡æ ‡å‡†å·®æ’å' },
                { key: 'solved_avg_rank', label: 'å•æ¬¡å¹³å‡(å»æå€¼)æ’å' },
                { key: 'solved_median_rank', label: 'å•æ¬¡ä¸­ä½æ•°æ’å' },
                { key: 'solved_mode_rank', label: 'å•æ¬¡ä¼—æ•°æ’å' },
                { key: 'solved_mode_count_rank', label: 'å•æ¬¡ä¼—æ•°æ¬¡æ•°æ’å' },
                { key: 'solved_min_rank', label: 'å•æ¬¡æœ€å°æ’å' },
                { key: 'solved_max_rank', label: 'å•æ¬¡æœ€å¤§æ’å' },
                { key: 'solved_consecutive_rank', label: 'å•æ¬¡è¿ç»­æ¬¡æ•°æ’å' },
                { key: 'solved_consecutive_start_rank', label: 'å•æ¬¡è¿ç»­å¼€å§‹æ’å' },
                { key: 'solved_consecutive_end_rank', label: 'å•æ¬¡è¿ç»­ç»“æŸæ’å' },
                { key: 'solved_mo3_last_rank', label: 'MO3 æœ€åæ’å' },
                { key: 'solved_mo3_best_rank', label: 'MO3 æœ€ä½³æ’å' },
                { key: 'solved_mo5_last_rank', label: 'MO5 æœ€åæ’å' },
                { key: 'solved_mo5_best_rank', label: 'MO5 æœ€ä½³æ’å' },
                { key: 'solved_mo12_last_rank', label: 'MO12 æœ€åæ’å' },
                { key: 'solved_mo12_best_rank', label: 'MO12 æœ€ä½³æ’å' },
                { key: 'solved_mo50_last_rank', label: 'MO50 æœ€åæ’å' },
                { key: 'solved_mo50_best_rank', label: 'MO50 æœ€ä½³æ’å' },
                { key: 'solved_mo100_last_rank', label: 'MO100 æœ€åæ’å' },
                { key: 'solved_mo100_best_rank', label: 'MO100 æœ€ä½³æ’å' },
                { key: 'solved_ao5_last_rank', label: 'AO5 æœ€åæ’å' },
                { key: 'solved_ao5_best_rank', label: 'AO5 æœ€ä½³æ’å' },
                { key: 'solved_ao12_last_rank', label: 'AO12 æœ€åæ’å' },
                { key: 'solved_ao12_best_rank', label: 'AO12 æœ€ä½³æ’å' },
                { key: 'solved_ao50_last_rank', label: 'AO50 æœ€åæ’å' },
                { key: 'solved_ao50_best_rank', label: 'AO50 æœ€ä½³æ’å' },
                { key: 'solved_ao100_last_rank', label: 'AO100 æœ€åæ’å' },
                { key: 'solved_ao100_best_rank', label: 'AO100 æœ€ä½³æ’å' },
                { key: 'avg_item_3rd_min_rank', label: 'å¹³å‡ç¬¬ä¸‰é¡¹æœ€å°æ’å' },
                { key: 'avg_item_3rd_max_rank', label: 'å¹³å‡ç¬¬ä¸‰é¡¹æœ€å¤§æ’å' },
                { key: 'avg_item_2nd_min_rank', label: 'å¹³å‡ç¬¬äºŒé¡¹æœ€å°æ’å' },
                { key: 'avg_item_2nd_max_rank', label: 'å¹³å‡ç¬¬äºŒé¡¹æœ€å¤§æ’å' },
                { key: 'competitions_rank', label: 'æ¯”èµ›æ¬¡æ•°æ’å' },
                { key: 'rounds_rank', label: 'è½®æ¬¡æ’å' },
                { key: 'chances_rank', label: 'æœºä¼šæ•°æ’å' },
                { key: 'attempts_rank', label: 'å°è¯•æ¬¡æ•°æ’å' },
                { key: 'gold_rank', label: 'é‡‘ç‰Œæ’å' },
                { key: 'silver_rank', label: 'é“¶ç‰Œæ’å' },
                { key: 'bronze_rank', label: 'é“œç‰Œæ’å' }
            ],
            'å›½å®¶æ’å': [
                { key: 'best_nr', label: 'æœ€ä½³å›½å®¶æ’å' },
                { key: 'best_max_nr', label: 'æœ€ä½³æœ€å¤§å›½å®¶æ’å' },
                { key: 'best_count_nr', label: 'æœ€ä½³æ¬¡æ•°å›½å®¶æ’å' },
                { key: 'best_nunique_nr', label: 'æœ€ä½³å”¯ä¸€å€¼æ•°å›½å®¶æ’å' },
                { key: 'best_mean_nr', label: 'æœ€ä½³å¹³å‡å›½å®¶æ’å' },
                { key: 'best_std_nr', label: 'æœ€ä½³æ ‡å‡†å·®å›½å®¶æ’å' },
                { key: 'best_avg_nr', label: 'æœ€ä½³å¹³å‡(å»æå€¼)å›½å®¶æ’å' },
                { key: 'best_median_nr', label: 'æœ€ä½³ä¸­ä½æ•°å›½å®¶æ’å' },
                { key: 'best_mode_nr', label: 'æœ€ä½³ä¼—æ•°å›½å®¶æ’å' },
                { key: 'best_mode_count_nr', label: 'æœ€ä½³ä¼—æ•°æ¬¡æ•°å›½å®¶æ’å' },
                { key: 'best_consecutive_nr', label: 'æœ€ä½³è¿ç»­æ¬¡æ•°å›½å®¶æ’å' },
                { key: 'best_consecutive_start_nr', label: 'æœ€ä½³è¿ç»­å¼€å§‹å›½å®¶æ’å' },
                { key: 'best_consecutive_end_nr', label: 'æœ€ä½³è¿ç»­ç»“æŸå›½å®¶æ’å' },
                { key: 'average_nr', label: 'å¹³å‡å›½å®¶æ’å' },
                { key: 'average_max_nr', label: 'å¹³å‡æœ€å¤§å›½å®¶æ’å' },
                { key: 'average_count_nr', label: 'å¹³å‡æ¬¡æ•°å›½å®¶æ’å' },
                { key: 'average_nunique_nr', label: 'å¹³å‡å”¯ä¸€å€¼æ•°å›½å®¶æ’å' },
                { key: 'average_mean_nr', label: 'å¹³å‡å‡å€¼å›½å®¶æ’å' },
                { key: 'average_std_nr', label: 'å¹³å‡æ ‡å‡†å·®å›½å®¶æ’å' },
                { key: 'average_avg_nr', label: 'å¹³å‡(å»æå€¼)å›½å®¶æ’å' },
                { key: 'average_median_nr', label: 'å¹³å‡ä¸­ä½æ•°å›½å®¶æ’å' },
                { key: 'average_mode_nr', label: 'å¹³å‡ä¼—æ•°å›½å®¶æ’å' },
                { key: 'average_mode_count_nr', label: 'å¹³å‡ä¼—æ•°æ¬¡æ•°å›½å®¶æ’å' },
                { key: 'average_consecutive_nr', label: 'å¹³å‡è¿ç»­æ¬¡æ•°å›½å®¶æ’å' },
                { key: 'average_consecutive_start_nr', label: 'å¹³å‡è¿ç»­å¼€å§‹å›½å®¶æ’å' },
                { key: 'average_consecutive_end_nr', label: 'å¹³å‡è¿ç»­ç»“æŸå›½å®¶æ’å' },
                { key: 'average_attempts_nr', label: 'å¹³å‡å°è¯•æ¬¡æ•°å›½å®¶æ’å' },
                { key: 'solved_count_nr', label: 'æˆåŠŸæ¬¡æ•°å›½å®¶æ’å' },
                { key: 'solved_nunique_nr', label: 'æˆåŠŸå”¯ä¸€å€¼æ•°å›½å®¶æ’å' },
                { key: 'solved_mean_nr', label: 'å•æ¬¡å¹³å‡å›½å®¶æ’å' },
                { key: 'solved_std_nr', label: 'å•æ¬¡æ ‡å‡†å·®å›½å®¶æ’å' },
                { key: 'solved_avg_nr', label: 'å•æ¬¡å¹³å‡(å»æå€¼)å›½å®¶æ’å' },
                { key: 'solved_median_nr', label: 'å•æ¬¡ä¸­ä½æ•°å›½å®¶æ’å' },
                { key: 'solved_mode_nr', label: 'å•æ¬¡ä¼—æ•°å›½å®¶æ’å' },
                { key: 'solved_mode_count_nr', label: 'å•æ¬¡ä¼—æ•°æ¬¡æ•°å›½å®¶æ’å' },
                { key: 'solved_min_nr', label: 'å•æ¬¡æœ€å°å›½å®¶æ’å' },
                { key: 'solved_max_nr', label: 'å•æ¬¡æœ€å¤§å›½å®¶æ’å' },
                { key: 'solved_consecutive_nr', label: 'å•æ¬¡è¿ç»­æ¬¡æ•°å›½å®¶æ’å' },
                { key: 'solved_consecutive_start_nr', label: 'å•æ¬¡è¿ç»­å¼€å§‹å›½å®¶æ’å' },
                { key: 'solved_consecutive_end_nr', label: 'å•æ¬¡è¿ç»­ç»“æŸå›½å®¶æ’å' },
                { key: 'solved_mo3_last_nr', label: 'MO3 æœ€åå›½å®¶æ’å' },
                { key: 'solved_mo3_best_nr', label: 'MO3 æœ€ä½³å›½å®¶æ’å' },
                { key: 'solved_mo5_last_nr', label: 'MO5 æœ€åå›½å®¶æ’å' },
                { key: 'solved_mo5_best_nr', label: 'MO5 æœ€ä½³å›½å®¶æ’å' },
                { key: 'solved_mo12_last_nr', label: 'MO12 æœ€åå›½å®¶æ’å' },
                { key: 'solved_mo12_best_nr', label: 'MO12 æœ€ä½³å›½å®¶æ’å' },
                { key: 'solved_mo50_last_nr', label: 'MO50 æœ€åå›½å®¶æ’å' },
                { key: 'solved_mo50_best_nr', label: 'MO50 æœ€ä½³å›½å®¶æ’å' },
                { key: 'solved_mo100_last_nr', label: 'MO100 æœ€åå›½å®¶æ’å' },
                { key: 'solved_mo100_best_nr', label: 'MO100 æœ€ä½³å›½å®¶æ’å' },
                { key: 'solved_ao5_last_nr', label: 'AO5 æœ€åå›½å®¶æ’å' },
                { key: 'solved_ao5_best_nr', label: 'AO5 æœ€ä½³å›½å®¶æ’å' },
                { key: 'solved_ao12_last_nr', label: 'AO12 æœ€åå›½å®¶æ’å' },
                { key: 'solved_ao12_best_nr', label: 'AO12 æœ€ä½³å›½å®¶æ’å' },
                { key: 'solved_ao50_last_nr', label: 'AO50 æœ€åå›½å®¶æ’å' },
                { key: 'solved_ao50_best_nr', label: 'AO50 æœ€ä½³å›½å®¶æ’å' },
                { key: 'solved_ao100_last_nr', label: 'AO100 æœ€åå›½å®¶æ’å' },
                { key: 'solved_ao100_best_nr', label: 'AO100 æœ€ä½³å›½å®¶æ’å' },
                { key: 'avg_item_3rd_min_nr', label: 'å¹³å‡ç¬¬ä¸‰é¡¹æœ€å°å›½å®¶æ’å' },
                { key: 'avg_item_3rd_max_nr', label: 'å¹³å‡ç¬¬ä¸‰é¡¹æœ€å¤§å›½å®¶æ’å' },
                { key: 'avg_item_2nd_min_nr', label: 'å¹³å‡ç¬¬äºŒé¡¹æœ€å°å›½å®¶æ’å' },
                { key: 'avg_item_2nd_max_nr', label: 'å¹³å‡ç¬¬äºŒé¡¹æœ€å¤§å›½å®¶æ’å' },
                { key: 'competitions_nr', label: 'æ¯”èµ›æ¬¡æ•°å›½å®¶æ’å' },
                { key: 'rounds_nr', label: 'è½®æ¬¡å›½å®¶æ’å' },
                { key: 'chances_nr', label: 'æœºä¼šæ•°å›½å®¶æ’å' },
                { key: 'attempts_nr', label: 'å°è¯•æ¬¡æ•°å›½å®¶æ’å' },
                { key: 'gold_nr', label: 'é‡‘ç‰Œå›½å®¶æ’å' },
                { key: 'silver_nr', label: 'é“¶ç‰Œå›½å®¶æ’å' },
                { key: 'bronze_nr', label: 'é“œç‰Œå›½å®¶æ’å' }
            ],
            'å…¶ä»–': [
                { key: 'avg_item_3rd_min', label: 'å¹³å‡ç¬¬ä¸‰é¡¹æœ€å°' },
                { key: 'avg_item_3rd_max', label: 'å¹³å‡ç¬¬ä¸‰é¡¹æœ€å¤§' },
                { key: 'avg_item_2nd_min', label: 'å¹³å‡ç¬¬äºŒé¡¹æœ€å°' },
                { key: 'avg_item_2nd_max', label: 'å¹³å‡ç¬¬äºŒé¡¹æœ€å¤§' }
            ]
        };
        
        // é»˜è®¤æ˜¾ç¤ºçš„åˆ—
        const defaultColumns = [
            'personName', 'best', 'best_rank', 'average', 'average_rank',
            'solved_mean', 'solved_mean_rank', 'competitions', 'rounds',
            'solved_count', 'gold', 'silver', 'bronze'
        ];

        // åˆå§‹åŒ–åˆ—é€‰æ‹©å™¨
        function initColumnSelector() {
            const panel = document.getElementById('columnCheckboxes');
            panel.innerHTML = '';
            
            // ä» localStorage åŠ è½½ä¿å­˜çš„åˆ—é€‰æ‹©ï¼ˆæŒ‰æ–‡ä»¶åˆ†åˆ«ä¿å­˜ï¼‰
            const savedColumnsKey = `visibleColumns_${currentFile}`;
            const savedColumns = localStorage.getItem(savedColumnsKey);
            if (savedColumns) {
                visibleColumns = JSON.parse(savedColumns);
                // è¿‡æ»¤æ‰å½“å‰æ–‡ä»¶ä¸­ä¸å­˜åœ¨çš„åˆ—
                visibleColumns = visibleColumns.filter(col => allHeaders.includes(col));
            } else {
                // ä½¿ç”¨é»˜è®¤åˆ—ï¼Œä½†åªåŒ…å«å½“å‰æ–‡ä»¶ä¸­å­˜åœ¨çš„åˆ—
                visibleColumns = defaultColumns.filter(col => allHeaders.includes(col));
            }
            
            // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªåˆ—è¢«é€‰ä¸­
            if (visibleColumns.length === 0 && allHeaders.length > 0) {
                visibleColumns = allHeaders.includes('personName') ? ['personName'] : [allHeaders[0]];
            }
            
            // åˆ›å»ºæ‰€æœ‰åˆ—çš„å¤é€‰æ¡†
            Object.keys(columnDefinitions).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'column-category';
                
                // åˆ›å»ºåˆ†ç»„æ ‡é¢˜å®¹å™¨
                const headerDiv = document.createElement('div');
                headerDiv.className = 'column-category-header';
                
                const h4 = document.createElement('h4');
                h4.textContent = category;
                headerDiv.appendChild(h4);
                
                // åˆ›å»ºåˆ†ç»„æ“ä½œæŒ‰é’®
                const categoryActions = document.createElement('div');
                categoryActions.className = 'category-actions';
                
                const selectAllBtn = document.createElement('button');
                selectAllBtn.textContent = 'å…¨é€‰';
                selectAllBtn.type = 'button';
                selectAllBtn.onclick = () => {
                    const categoryCheckboxes = categoryDiv.querySelectorAll('input[type="checkbox"]');
                    categoryCheckboxes.forEach(cb => cb.checked = true);
                };
                
                const selectNoneBtn = document.createElement('button');
                selectNoneBtn.textContent = 'å…¨ä¸é€‰';
                selectNoneBtn.type = 'button';
                selectNoneBtn.onclick = () => {
                    const categoryCheckboxes = categoryDiv.querySelectorAll('input[type="checkbox"]');
                    categoryCheckboxes.forEach(cb => cb.checked = false);
                };
                
                categoryActions.appendChild(selectAllBtn);
                categoryActions.appendChild(selectNoneBtn);
                headerDiv.appendChild(categoryActions);
                categoryDiv.appendChild(headerDiv);
                
                const checkboxesDiv = document.createElement('div');
                checkboxesDiv.className = 'column-checkboxes';
                
                columnDefinitions[category].forEach(col => {
                    // åªæ˜¾ç¤º CSV ä¸­å®é™…å­˜åœ¨çš„åˆ—
                    if (!allHeaders.includes(col.key)) return;
                    
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'column-checkbox';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `col_${col.key}`;
                    checkbox.value = col.key;
                    checkbox.checked = visibleColumns.includes(col.key);
                    
                    const label = document.createElement('label');
                    label.htmlFor = `col_${col.key}`;
                    label.textContent = col.label;
                    
                    checkboxDiv.appendChild(checkbox);
                    checkboxDiv.appendChild(label);
                    checkboxesDiv.appendChild(checkboxDiv);
                });
                
                if (checkboxesDiv.children.length > 0) {
                    categoryDiv.appendChild(checkboxesDiv);
                    panel.appendChild(categoryDiv);
                }
            });
            
            // æ›´æ–°æ’åºä¸‹æ‹‰èœå•
            updateSortColumnSelect();
        }
        
        // æ›´æ–°æ’åºå­—æ®µä¸‹æ‹‰èœå•
        function updateSortColumnSelect() {
            const select = document.getElementById('sortColumn');
            const currentValue = select.value;
            select.innerHTML = '';
            
            // æ·»åŠ å¸¸ç”¨å­—æ®µ
            const commonFields = [
                { value: 'best_rank', label: 'æœ€ä½³æˆç»©æ’å' },
                { value: 'average_rank', label: 'å¹³å‡æˆç»©æ’å' },
                { value: 'solved_mean_rank', label: 'å•æ¬¡å¹³å‡æ’å' },
                { value: 'best', label: 'æœ€ä½³æˆç»©' },
                { value: 'average', label: 'å¹³å‡æˆç»©' },
                { value: 'solved_mean', label: 'å•æ¬¡å¹³å‡' },
                { value: 'competitions', label: 'æ¯”èµ›æ¬¡æ•°' },
                { value: 'rounds', label: 'è½®æ¬¡' }
            ];
            
            commonFields.forEach(field => {
                if (allHeaders.includes(field.value)) {
                    const option = document.createElement('option');
                    option.value = field.value;
                    option.textContent = field.label;
                    if (field.value === currentValue) option.selected = true;
                    select.appendChild(option);
                }
            });
            
            // æ·»åŠ åˆ†éš”çº¿
            if (visibleColumns.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'å…¶ä»–å­—æ®µ';
                select.appendChild(optgroup);
                
                visibleColumns.forEach(colKey => {
                    if (!commonFields.find(f => f.value === colKey)) {
                        const option = document.createElement('option');
                        option.value = colKey;
                        option.textContent = getColumnLabel(colKey);
                        if (colKey === currentValue) option.selected = true;
                        optgroup.appendChild(option);
                    }
                });
            }
        }
        
        // æ›´æ–°é¡µé¢æ ‡é¢˜å’Œæè¿°
        function updateHeader() {
            const config = fileConfigs[currentFile];
            if (config) {
                document.getElementById('headerDescription').textContent = config.description;
            }
        }
        
        // åŠ è½½ CSV æ•°æ®
        async function loadData(filename = null) {
            if (filename) {
                currentFile = filename;
                // ä¿å­˜åˆ° localStorage
                localStorage.setItem('currentFile', currentFile);
            } else {
                // ä» localStorage åŠ è½½ä¿å­˜çš„æ–‡ä»¶é€‰æ‹©
                const savedFile = localStorage.getItem('currentFile');
                if (savedFile && fileConfigs[savedFile]) {
                    currentFile = savedFile;
                    document.getElementById('fileSelect').value = currentFile;
                }
            }
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            updateHeader();
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('dataTable').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';
            
            try {
                const response = await fetch(currentFile);
                if (!response.ok) {
                    throw new Error(`æ–‡ä»¶ ${currentFile} ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®`);
                }
                
                const text = await response.text();
                const lines = text.trim().split('\n');
                if (lines.length < 2) {
                    throw new Error('CSV æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–ä¸ºç©º');
                }
                
                allHeaders = parseCSVLine(lines[0]);
                
                allData = lines.slice(1).map(line => {
                    const values = parseCSVLine(line);
                    const row = {};
                    allHeaders.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    return row;
                });

                filteredData = [...allData];
                
                // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                currentPage = 1;
                
                // é‡æ–°åˆå§‹åŒ–åˆ—é€‰æ‹©å™¨ï¼ˆå› ä¸ºä¸åŒæ–‡ä»¶çš„åˆ—å¯èƒ½ä¸åŒï¼‰
                initColumnSelector();
                updateStats();
                renderTable();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';
                document.getElementById('pagination').style.display = 'flex';
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'åŠ è½½æ•°æ®å¤±è´¥: ' + error.message;
                console.error('åŠ è½½æ•°æ®é”™è¯¯:', error);
            }
        }

        // è§£æ CSV è¡Œï¼ˆå¤„ç†å¼•å·å†…çš„é€—å·ï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // æ›´æ–°ç»Ÿè®¡æ‘˜è¦
        function updateStats() {
            const validData = filteredData.filter(d => d.best && !isNaN(parseFloat(d.best)));
            const bestValues = validData.map(d => parseFloat(d.best));
            const avgValues = validData.filter(d => d.average && !isNaN(parseFloat(d.average)))
                .map(d => parseFloat(d.average));
            const competitions = validData.reduce((sum, d) => sum + (parseInt(d.competitions) || 0), 0);

            document.getElementById('totalPlayers').textContent = filteredData.length;
            document.getElementById('avgBest').textContent = bestValues.length > 0 
                ? (bestValues.reduce((a, b) => a + b, 0) / bestValues.length).toFixed(2)
                : '-';
            document.getElementById('avgAverage').textContent = avgValues.length > 0
                ? (avgValues.reduce((a, b) => a + b, 0) / avgValues.length).toFixed(2)
                : '-';
            document.getElementById('totalCompetitions').textContent = competitions;
        }

        // æ’åºæ•°æ®
        function sortData() {
            filteredData.sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];

                // å¤„ç†æ•°å­—
                if (!isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB))) {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                }

                if (valA === '' || valA === null) return 1;
                if (valB === '' || valB === null) return -1;

                let comparison = 0;
                if (valA < valB) comparison = -1;
                if (valA > valB) comparison = 1;

                return sortOrder === 'asc' ? comparison : -comparison;
            });
        }

        // è·å–åˆ—çš„æ˜¾ç¤ºåç§°
        function getColumnLabel(key) {
            for (const category of Object.values(columnDefinitions)) {
                const col = category.find(c => c.key === key);
                if (col) return col.label;
            }
            return key;
        }
        
        // åˆ¤æ–­åˆ—æ˜¯å¦ä¸ºæ•°å­—ç±»å‹
        function isNumberColumn(key) {
            return key !== 'personName' && key !== 'personId' && key !== 'countryId' && key !== 'gender';
        }
        
        // åˆ¤æ–­åˆ—æ˜¯å¦ä¸ºæ’åç±»å‹
        function isRankColumn(key) {
            return key.endsWith('_rank') || key.endsWith('_nr');
        }
        
        // åˆ¤æ–­åˆ—æ˜¯å¦ä¸ºå¥–ç‰Œç±»å‹
        function isMedalColumn(key) {
            return key === 'gold' || key === 'silver' || key === 'bronze';
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            sortData();
            
            const thead = document.querySelector('#dataTable thead tr');
            const tbody = document.getElementById('tableBody');
            
            // æ¸²æŸ“è¡¨å¤´
            thead.innerHTML = '';
            visibleColumns.forEach(colKey => {
                const th = document.createElement('th');
                th.className = 'sortable';
                if (isNumberColumn(colKey)) {
                    th.className += ' number';
                }
                if (isRankColumn(colKey)) {
                    th.className += ' rank';
                }
                th.dataset.column = colKey;
                th.textContent = getColumnLabel(colKey);
                thead.appendChild(th);
            });
            
            // æ¸²æŸ“è¡¨æ ¼å†…å®¹
            tbody.innerHTML = '';

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            const formatNumber = (val) => {
                if (!val || val === '' || val === 'NaN') return '-';
                const num = parseFloat(val);
                return isNaN(num) ? val : num.toFixed(2);
            };
            
            const formatInteger = (val) => {
                if (!val || val === '' || val === 'NaN') return '-';
                const num = parseFloat(val);
                return isNaN(num) ? val : Math.round(num).toString();
            };

            pageData.forEach((row) => {
                const tr = document.createElement('tr');
                
                visibleColumns.forEach(colKey => {
                    const td = document.createElement('td');
                    let value = row[colKey] || '-';
                    
                    if (isNumberColumn(colKey) && value !== '-') {
                        td.className = 'number';
                        if (isRankColumn(colKey)) {
                            td.className += ' rank';
                            value = formatInteger(value);
                        } else if (isMedalColumn(colKey)) {
                            if (colKey === 'gold') td.className += ' medal-gold';
                            else if (colKey === 'silver') td.className += ' medal-silver';
                            else if (colKey === 'bronze') td.className += ' medal-bronze';
                            value = formatInteger(value);
                        } else {
                            value = formatNumber(value);
                        }
                    }
                    
                    td.textContent = value;
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = 
                `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ (å…± ${filteredData.length} æ¡è®°å½•)`;
            
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;

            // æ›´æ–°è¡¨å¤´æ’åºæŒ‡ç¤ºå™¨å’Œäº‹ä»¶
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.column === sortColumn) {
                    th.classList.add(sortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
                }
                
                // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                th.onclick = () => {
                    const column = th.dataset.column;
                    if (sortColumn === column) {
                        sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = column;
                        sortOrder = 'asc';
                    }
                    renderTable();
                };
            });
        }

        // æœç´¢åŠŸèƒ½
        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            filteredData = allData.filter(row => {
                const name = (row.personName || '').toLowerCase();
                return name.includes(searchTerm);
            });
            currentPage = 1;
            updateStats();
            renderTable();
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('fileSelect').addEventListener('change', (e) => {
            loadData(e.target.value);
        });

        document.getElementById('sortColumn').addEventListener('change', (e) => {
            sortColumn = e.target.value;
            renderTable();
        });

        document.getElementById('sortOrder').addEventListener('change', (e) => {
            sortOrder = e.target.value;
            renderTable();
        });

        document.getElementById('searchInput').addEventListener('input', filterData);

        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        // åˆ—é€‰æ‹©å™¨äº‹ä»¶
        document.getElementById('columnSelectorBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            const panel = document.getElementById('columnSelectorPanel');
            panel.classList.toggle('show');
        });
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­é¢æ¿
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('columnSelectorPanel');
            const btn = document.getElementById('columnSelectorBtn');
            if (!panel.contains(e.target) && e.target !== btn) {
                panel.classList.remove('show');
            }
        });
        
        document.getElementById('selectAllBtn').addEventListener('click', () => {
            document.querySelectorAll('#columnCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
        });
        
        document.getElementById('selectNoneBtn').addEventListener('click', () => {
            document.querySelectorAll('#columnCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        });
        
        document.getElementById('selectDefaultBtn').addEventListener('click', () => {
            document.querySelectorAll('#columnCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = defaultColumns.includes(cb.value);
            });
        });
        
        document.getElementById('applyColumnsBtn').addEventListener('click', () => {
            visibleColumns = [];
            document.querySelectorAll('#columnCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                visibleColumns.push(cb.value);
            });
            
            // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªåˆ—è¢«é€‰ä¸­
            if (visibleColumns.length === 0) {
                const defaultCol = allHeaders.includes('personName') ? 'personName' : allHeaders[0];
                visibleColumns = [defaultCol];
                alert('è‡³å°‘éœ€è¦é€‰æ‹©ä¸€ä¸ªåˆ—ï¼å·²è‡ªåŠ¨é€‰æ‹©é»˜è®¤åˆ—ã€‚');
            }
            
            // ä¿å­˜åˆ° localStorageï¼ˆæŒ‰æ–‡ä»¶åˆ†åˆ«ä¿å­˜ï¼‰
            const savedColumnsKey = `visibleColumns_${currentFile}`;
            localStorage.setItem(savedColumnsKey, JSON.stringify(visibleColumns));
            
            // å…³é—­é¢æ¿
            document.getElementById('columnSelectorPanel').classList.remove('show');
            
            // æ›´æ–°æ’åºä¸‹æ‹‰èœå•
            updateSortColumnSelect();
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            currentPage = 1;
            renderTable();
        });

        // åˆå§‹åŒ–
        loadData();
    </script>
</body>
</html>

