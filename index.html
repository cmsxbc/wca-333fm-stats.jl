<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WCA ä¸‰é˜¶æœ€å°‘æ­¥ (333fm) ç»Ÿè®¡æ•°æ®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #555;
        }

        .control-group select,
        .control-group input,
        .control-group button {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
            cursor: pointer;
        }

        .control-group label input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .control-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .control-group button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .column-selector {
            position: relative;
        }

        .column-selector-panel {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 10px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            min-width: 400px;
            display: none;
        }

        .column-selector-panel.show {
            display: block;
        }

        .column-category {
            margin-bottom: 20px;
        }

        .column-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .column-category h4 {
            margin: 0;
            color: #667eea;
            font-size: 1em;
        }

        .category-actions {
            display: flex;
            gap: 8px;
        }

        .category-actions button {
            padding: 4px 12px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .category-actions button:hover {
            background: #667eea;
            color: white;
        }

        .column-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }

        .column-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .column-checkbox label {
            cursor: pointer;
            font-weight: normal;
            font-size: 0.9em;
        }

        .column-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .column-actions button {
            flex: 1;
            padding: 8px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .column-actions button:hover {
            background: #667eea;
            color: white;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #666;
            font-size: 0.9em;
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        th:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        th.sortable::after {
            content: ' â†•';
            opacity: 0.5;
            font-size: 0.8em;
        }

        th.sort-asc::after {
            content: ' â†‘';
            opacity: 1;
        }

        th.sort-desc::after {
            content: ' â†“';
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f5f5f5;
        }

        tbody tr:nth-child(even) {
            background: #fafafa;
        }

        tbody tr:nth-child(even):hover {
            background: #f0f0f0;
        }

        td {
            padding: 12px 10px;
            white-space: nowrap;
        }

        td .rank-info {
            font-size: 0.85em;
            color: #888;
            margin-left: 5px;
        }

        td .rank-info .rank-value {
            color: #667eea;
            font-weight: 600;
        }

        .number {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .rank {
            font-weight: bold;
            color: #667eea;
        }

        .medal-gold {
            color: #ffd700;
            font-weight: bold;
        }

        .medal-silver {
            color: #c0c0c0;
            font-weight: bold;
        }

        .medal-bronze {
            color: #cd7f32;
            font-weight: bold;
        }

        .pagination {
            padding: 20px 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
        }

        .pagination button {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            padding: 10px 20px;
            font-weight: 600;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ† WCA ä¸‰é˜¶æœ€å°‘æ­¥ (333fm) ç»Ÿè®¡æ•°æ®</h1>
            <p id="headerDescription">ä¸­å›½é€‰æ‰‹ Top 30 æ’è¡Œæ¦œ</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="fileSelect">æ•°æ®æ–‡ä»¶:</label>
                <select id="fileSelect">
                    <option value="results.china.top30.csv">ä¸­å›½ Top 30</option>
                    <option value="results.top100.csv">å…¨çƒ Top 100</option>
                    <option value="results.csv">å®Œæ•´æ•°æ®</option>
                </select>
            </div>
            <div class="control-group">
                <label for="sortColumn">æ’åºå­—æ®µ:</label>
                <select id="sortColumn">
                    <option value="best">æœ€ä½³æˆç»©</option>
                    <option value="average">å¹³å‡æˆç»©</option>
                    <option value="solved_mean">å•æ¬¡å¹³å‡</option>
                    <option value="competitions">æ¯”èµ›æ¬¡æ•°</option>
                    <option value="rounds">è½®æ¬¡</option>
                </select>
            </div>
            <div class="control-group">
                <label for="sortOrder">æ’åºæ–¹å¼:</label>
                <select id="sortOrder">
                    <option value="asc">å‡åº</option>
                    <option value="desc">é™åº</option>
                </select>
            </div>
            <div class="control-group">
                <label for="searchInput">æœç´¢:</label>
                <input type="text" id="searchInput" placeholder="è¾“å…¥å§“åæœç´¢...">
            </div>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="showRanks" checked>
                    æ˜¾ç¤ºæ’å
                </label>
            </div>
            <div class="control-group column-selector">
                <button id="columnSelectorBtn">é€‰æ‹©åˆ—...</button>
                <div class="column-selector-panel" id="columnSelectorPanel">
                    <div id="columnCheckboxes"></div>
                    <div class="column-actions">
                        <button id="selectAllBtn">å…¨é€‰</button>
                        <button id="selectNoneBtn">å…¨ä¸é€‰</button>
                        <button id="selectDefaultBtn">é»˜è®¤</button>
                        <button id="applyColumnsBtn">åº”ç”¨</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-summary" id="statsSummary">
            <div class="stat-card">
                <div class="value" id="totalPlayers">-</div>
                <div class="label">æ€»é€‰æ‰‹æ•°</div>
            </div>
            <div class="stat-card">
                <div class="value" id="avgBest">-</div>
                <div class="label">å¹³å‡æœ€ä½³æˆç»©</div>
            </div>
            <div class="stat-card">
                <div class="value" id="avgAverage">-</div>
                <div class="label">å¹³å‡æˆç»©</div>
            </div>
            <div class="stat-card">
                <div class="value" id="totalCompetitions">-</div>
                <div class="label">æ€»æ¯”èµ›æ¬¡æ•°</div>
            </div>
        </div>

        <div class="table-container">
            <div id="loading" class="loading">åŠ è½½æ•°æ®ä¸­...</div>
            <div id="error" class="error" style="display: none;"></div>
            <table id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th class="sortable" data-column="personName">å§“å</th>
                        <th class="sortable number" data-column="best">æœ€ä½³</th>
                        <th class="sortable number" data-column="best_rank">æœ€ä½³æ’å</th>
                        <th class="sortable number" data-column="average">å¹³å‡</th>
                        <th class="sortable number" data-column="average_rank">å¹³å‡æ’å</th>
                        <th class="sortable number" data-column="solved_mean">å•æ¬¡å¹³å‡</th>
                        <th class="sortable number" data-column="solved_mean_rank">å•æ¬¡æ’å</th>
                        <th class="sortable number" data-column="competitions">æ¯”èµ›</th>
                        <th class="sortable number" data-column="rounds">è½®æ¬¡</th>
                        <th class="sortable number" data-column="solved_count">æˆåŠŸæ¬¡æ•°</th>
                        <th class="sortable number" data-column="gold">ğŸ¥‡</th>
                        <th class="sortable number" data-column="silver">ğŸ¥ˆ</th>
                        <th class="sortable number" data-column="bronze">ğŸ¥‰</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>

        <div class="pagination" id="pagination" style="display: none;">
            <button id="prevPage">ä¸Šä¸€é¡µ</button>
            <div class="page-info" id="pageInfo">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</div>
            <button id="nextPage">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 30;
        let sortColumn = 'best'; // åŸºç¡€åˆ—åï¼Œå®é™…æ’åºä¼šä½¿ç”¨æ’ååˆ—
        let sortOrder = 'asc';
        let allHeaders = [];
        let visibleColumns = [];
        let currentFile = 'results.china.top30.csv';
        let showRanks = true; // å…¨å±€å¼€å…³ï¼šæ˜¯å¦æ˜¾ç¤ºæ’å

        // æ–‡ä»¶é…ç½®
        const fileConfigs = {
            'results.china.top30.csv': {
                name: 'ä¸­å›½ Top 30',
                description: 'ä¸­å›½é€‰æ‰‹ Top 30 æ’è¡Œæ¦œ'
            },
            'results.top100.csv': {
                name: 'å…¨çƒ Top 100',
                description: 'å…¨çƒ Top 100 æ’è¡Œæ¦œ'
            },
            'results.csv': {
                name: 'å®Œæ•´æ•°æ®',
                description: 'å®Œæ•´ç»Ÿè®¡æ•°æ®ï¼ˆæ‰€æœ‰é€‰æ‰‹ï¼‰'
            }
        };

        // åˆ—å®šä¹‰ï¼ˆæŒ‰ç±»åˆ«ç»„ç»‡ï¼Œç»‘å®šåŸå§‹åˆ—ã€æ’ååˆ—ã€å›½å®¶æ’ååˆ—ï¼‰
        // æ ¼å¼: { base: 'åŸå§‹åˆ—å', label: 'æ˜¾ç¤ºåç§°', hasRank: true/false, isInteger: true/false }
        // hasRankä¸ºtrueæ—¶ï¼Œä¼šè‡ªåŠ¨æŸ¥æ‰¾ base + '_rank' å’Œ base + '_nr'
        // isIntegerä¸ºtrueæ—¶ï¼Œæ˜¾ç¤ºä¸ºæ•´æ•°æ ¼å¼
        const columnDefinitions = {
            'åŸºæœ¬ä¿¡æ¯': [
                { base: 'personName', label: 'å§“å', hasRank: false, isInteger: false },
                { base: 'personId', label: 'ID', hasRank: false, isInteger: false },
                { base: 'countryId', label: 'å›½å®¶', hasRank: false, isInteger: false },
                { base: 'gender', label: 'æ€§åˆ«', hasRank: false, isInteger: false }
            ],
            'æ¯”èµ›ç»Ÿè®¡': [
                { base: 'competitions', label: 'æ¯”èµ›æ¬¡æ•°', hasRank: true, isInteger: true },
                { base: 'rounds', label: 'è½®æ¬¡', hasRank: true, isInteger: true },
                { base: 'chances', label: 'æœºä¼šæ•°', hasRank: true, isInteger: true },
                { base: 'attempts', label: 'å°è¯•æ¬¡æ•°', hasRank: true, isInteger: true }
            ],
            'æœ€ä½³æˆç»©': [
                { base: 'best', label: 'æœ€ä½³', hasRank: true, isInteger: true },
                { base: 'best_max', label: 'æœ€ä½³æœ€å¤§å€¼', hasRank: true, isInteger: true },
                { base: 'best_count', label: 'æœ€ä½³æ¬¡æ•°', hasRank: true, isInteger: true },
                { base: 'best_nunique', label: 'æœ€ä½³å”¯ä¸€å€¼æ•°', hasRank: true, isInteger: true },
                { base: 'best_mean', label: 'æœ€ä½³å¹³å‡', hasRank: true, isInteger: false },
                { base: 'best_std', label: 'æœ€ä½³æ ‡å‡†å·®', hasRank: true, isInteger: false },
                { base: 'best_avg', label: 'æœ€ä½³å¹³å‡(å»æå€¼)', hasRank: true, isInteger: false },
                { base: 'best_median', label: 'æœ€ä½³ä¸­ä½æ•°', hasRank: true, isInteger: false },
                { base: 'best_mode', label: 'æœ€ä½³ä¼—æ•°', hasRank: true, isInteger: true },
                { base: 'best_mode_count', label: 'æœ€ä½³ä¼—æ•°æ¬¡æ•°', hasRank: true, isInteger: true },
                { base: 'best_consecutive', label: 'æœ€ä½³è¿ç»­æ¬¡æ•°', hasRank: true, isInteger: true },
                { base: 'best_consecutive_start', label: 'æœ€ä½³è¿ç»­å¼€å§‹', hasRank: true, isInteger: true },
                { base: 'best_consecutive_end', label: 'æœ€ä½³è¿ç»­ç»“æŸ', hasRank: true, isInteger: true }
            ],
            'å¹³å‡æˆç»©': [
                { base: 'average', label: 'å¹³å‡', hasRank: true, isInteger: false },
                { base: 'average_max', label: 'å¹³å‡æœ€å¤§å€¼', hasRank: true, isInteger: false },
                { base: 'average_count', label: 'å¹³å‡æ¬¡æ•°', hasRank: true, isInteger: true },
                { base: 'average_nunique', label: 'å¹³å‡å”¯ä¸€å€¼æ•°', hasRank: true, isInteger: true },
                { base: 'average_mean', label: 'å¹³å‡å‡å€¼', hasRank: true, isInteger: false },
                { base: 'average_std', label: 'å¹³å‡æ ‡å‡†å·®', hasRank: true, isInteger: false },
                { base: 'average_avg', label: 'å¹³å‡(å»æå€¼)', hasRank: true, isInteger: false },
                { base: 'average_median', label: 'å¹³å‡ä¸­ä½æ•°', hasRank: true, isInteger: false },
                { base: 'average_mode', label: 'å¹³å‡ä¼—æ•°', hasRank: true, isInteger: false },
                { base: 'average_mode_count', label: 'å¹³å‡ä¼—æ•°æ¬¡æ•°', hasRank: true, isInteger: true },
                { base: 'average_consecutive', label: 'å¹³å‡è¿ç»­æ¬¡æ•°', hasRank: true, isInteger: true },
                { base: 'average_consecutive_start', label: 'å¹³å‡è¿ç»­å¼€å§‹', hasRank: true, isInteger: false },
                { base: 'average_consecutive_end', label: 'å¹³å‡è¿ç»­ç»“æŸ', hasRank: true, isInteger: false },
                { base: 'average_attempts', label: 'å¹³å‡å°è¯•æ¬¡æ•°', hasRank: true, isInteger: true }
            ],
            'å•æ¬¡æˆç»©': [
                { base: 'solved_count', label: 'æˆåŠŸæ¬¡æ•°', hasRank: true, isInteger: true },
                { base: 'solved_nunique', label: 'æˆåŠŸå”¯ä¸€å€¼æ•°', hasRank: true, isInteger: true },
                { base: 'solved_mean', label: 'å•æ¬¡å¹³å‡', hasRank: true, isInteger: false },
                { base: 'solved_std', label: 'å•æ¬¡æ ‡å‡†å·®', hasRank: true, isInteger: false },
                { base: 'solved_avg', label: 'å•æ¬¡å¹³å‡(å»æå€¼)', hasRank: true, isInteger: false },
                { base: 'solved_median', label: 'å•æ¬¡ä¸­ä½æ•°', hasRank: true, isInteger: false },
                { base: 'solved_mode', label: 'å•æ¬¡ä¼—æ•°', hasRank: true, isInteger: true },
                { base: 'solved_mode_count', label: 'å•æ¬¡ä¼—æ•°æ¬¡æ•°', hasRank: true, isInteger: true },
                { base: 'solved_min', label: 'å•æ¬¡æœ€å°å€¼', hasRank: true, isInteger: true },
                { base: 'solved_max', label: 'å•æ¬¡æœ€å¤§å€¼', hasRank: true, isInteger: true },
                { base: 'solved_consecutive', label: 'å•æ¬¡è¿ç»­æ¬¡æ•°', hasRank: true, isInteger: true },
                { base: 'solved_consecutive_start', label: 'å•æ¬¡è¿ç»­å¼€å§‹', hasRank: true, isInteger: true },
                { base: 'solved_consecutive_end', label: 'å•æ¬¡è¿ç»­ç»“æŸ', hasRank: true, isInteger: true }
            ],
            'æ»šåŠ¨å¹³å‡ - MO': [
                { base: 'solved_mo3_last', label: 'MO3 æœ€æ–°', hasRank: true, isInteger: false },
                { base: 'solved_mo3_best', label: 'MO3 æœ€ä½³', hasRank: true, isInteger: false },
                { base: 'solved_mo5_last', label: 'MO5 æœ€æ–°', hasRank: true, isInteger: false },
                { base: 'solved_mo5_best', label: 'MO5 æœ€ä½³', hasRank: true, isInteger: false },
                { base: 'solved_mo12_last', label: 'MO12 æœ€æ–°', hasRank: true, isInteger: false },
                { base: 'solved_mo12_best', label: 'MO12 æœ€ä½³', hasRank: true, isInteger: false },
                { base: 'solved_mo50_last', label: 'MO50 æœ€æ–°', hasRank: true, isInteger: false },
                { base: 'solved_mo50_best', label: 'MO50 æœ€ä½³', hasRank: true, isInteger: false },
                { base: 'solved_mo100_last', label: 'MO100 æœ€æ–°', hasRank: true, isInteger: false },
                { base: 'solved_mo100_best', label: 'MO100 æœ€ä½³', hasRank: true, isInteger: false }
            ],
            'æ»šåŠ¨å¹³å‡ - AO': [
                { base: 'solved_ao5_last', label: 'AO5 æœ€æ–°', hasRank: true, isInteger: false },
                { base: 'solved_ao5_best', label: 'AO5 æœ€ä½³', hasRank: true, isInteger: false },
                { base: 'solved_ao12_last', label: 'AO12 æœ€æ–°', hasRank: true, isInteger: false },
                { base: 'solved_ao12_best', label: 'AO12 æœ€ä½³', hasRank: true, isInteger: false },
                { base: 'solved_ao50_last', label: 'AO50 æœ€æ–°', hasRank: true, isInteger: false },
                { base: 'solved_ao50_best', label: 'AO50 æœ€ä½³', hasRank: true, isInteger: false },
                { base: 'solved_ao100_last', label: 'AO100 æœ€æ–°', hasRank: true, isInteger: false },
                { base: 'solved_ao100_best', label: 'AO100 æœ€ä½³', hasRank: true, isInteger: false }
            ],
            'å¥–ç‰Œ': [
                { base: 'gold', label: 'ğŸ¥‡ é‡‘ç‰Œ', hasRank: true, isInteger: true },
                { base: 'silver', label: 'ğŸ¥ˆ é“¶ç‰Œ', hasRank: true, isInteger: true },
                { base: 'bronze', label: 'ğŸ¥‰ é“œç‰Œ', hasRank: true, isInteger: true }
            ],
            'å…¶ä»–': [
                { base: 'avg_item_3rd_min', label: 'å¹³å‡ç¬¬ä¸‰é¡¹æœ€å°', hasRank: true, isInteger: true },
                { base: 'avg_item_3rd_max', label: 'å¹³å‡ç¬¬ä¸‰é¡¹æœ€å¤§', hasRank: true, isInteger: true },
                { base: 'avg_item_2nd_min', label: 'å¹³å‡ç¬¬äºŒé¡¹æœ€å°', hasRank: true, isInteger: true },
                { base: 'avg_item_2nd_max', label: 'å¹³å‡ç¬¬äºŒé¡¹æœ€å¤§', hasRank: true, isInteger: true }
            ]
        };

        // é»˜è®¤æ˜¾ç¤ºçš„åˆ—ï¼ˆåªæ˜¾ç¤ºåŸºç¡€åˆ—ï¼Œæ’åé€šè¿‡å¼€å…³æ§åˆ¶ï¼‰
        const defaultColumns = [
            'personName', 'best', 'average', 'solved_mean', 
            'competitions', 'rounds', 'solved_count', 'gold', 'silver', 'bronze'
        ];
        
        // æ£€æŸ¥åˆ—æ˜¯å¦å®Œæ•´ï¼ˆæœ‰æ’ååˆ—çš„æ•°æ®åˆ—å¿…é¡»æœ‰ä¸‰åˆ—ï¼‰
        function validateColumnGroup(baseCol) {
            const rankCol = baseCol + '_rank';
            const nrCol = baseCol + '_nr';
            const hasBase = allHeaders.includes(baseCol);
            const hasRank = allHeaders.includes(rankCol);
            const hasNr = allHeaders.includes(nrCol);
            
            if (hasBase && (hasRank || hasNr)) {
                // å¦‚æœæœ‰åŸºç¡€åˆ—å’Œè‡³å°‘ä¸€ä¸ªæ’ååˆ—ï¼Œæ£€æŸ¥æ˜¯å¦å®Œæ•´
                if (hasBase && hasRank && !hasNr) {
                    console.warn(`è­¦å‘Š: åˆ— ${baseCol} ç¼ºå°‘å›½å®¶æ’ååˆ— ${nrCol}`);
                    return false;
                }
                if (hasBase && hasNr && !hasRank) {
                    console.warn(`è­¦å‘Š: åˆ— ${baseCol} ç¼ºå°‘å…¨çƒæ’ååˆ— ${rankCol}`);
                    return false;
                }
                if (hasBase && !hasRank && !hasNr) {
                    // æ²¡æœ‰æ’ååˆ—ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼ˆå¦‚åŸºæœ¬ä¿¡æ¯åˆ—ï¼‰
                    return true;
                }
                return hasBase && hasRank && hasNr;
            }
            return true; // å¦‚æœåŸºç¡€åˆ—éƒ½ä¸å­˜åœ¨ï¼Œè¿”å›trueï¼ˆä¼šè¢«è¿‡æ»¤æ‰ï¼‰
        }

        // åˆå§‹åŒ–åˆ—é€‰æ‹©å™¨
        function initColumnSelector() {
            const panel = document.getElementById('columnCheckboxes');
            panel.innerHTML = '';

            // ä» localStorage åŠ è½½ä¿å­˜çš„åˆ—é€‰æ‹©ï¼ˆæŒ‰æ–‡ä»¶åˆ†åˆ«ä¿å­˜ï¼‰
            const savedColumnsKey = `visibleColumns_${currentFile}`;
            const savedColumns = localStorage.getItem(savedColumnsKey);
            if (savedColumns) {
                visibleColumns = JSON.parse(savedColumns);
                // è¿‡æ»¤æ‰å½“å‰æ–‡ä»¶ä¸­ä¸å­˜åœ¨çš„åˆ—
                visibleColumns = visibleColumns.filter(col => allHeaders.includes(col));
            } else {
                // ä½¿ç”¨é»˜è®¤åˆ—ï¼Œä½†åªåŒ…å«å½“å‰æ–‡ä»¶ä¸­å­˜åœ¨çš„åˆ—
                visibleColumns = defaultColumns.filter(col => allHeaders.includes(col));
            }

            // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªåˆ—è¢«é€‰ä¸­
            if (visibleColumns.length === 0 && allHeaders.length > 0) {
                visibleColumns = allHeaders.includes('personName') ? ['personName'] : [allHeaders[0]];
            }

            // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
            const missingColumns = [];
            Object.keys(columnDefinitions).forEach(category => {
                columnDefinitions[category].forEach(col => {
                    if (col.hasRank && allHeaders.includes(col.base)) {
                        const rankCol = col.base + '_rank';
                        const nrCol = col.base + '_nr';
                        const hasRank = allHeaders.includes(rankCol);
                        const hasNr = allHeaders.includes(nrCol);
                        
                        if (!hasRank || !hasNr) {
                            const missing = [];
                            if (!hasRank) missing.push(rankCol);
                            if (!hasNr) missing.push(nrCol);
                            missingColumns.push({
                                base: col.base,
                                label: col.label,
                                missing: missing
                            });
                        }
                    }
                });
            });
            
            if (missingColumns.length > 0) {
                const errorMsg = `æ•°æ®ä¸å®Œæ•´ï¼ä»¥ä¸‹åˆ—ç¼ºå°‘æ’ååˆ—ï¼š\n\n` +
                    missingColumns.map(m => `  ${m.label} (${m.base}): ç¼ºå°‘ ${m.missing.join(', ')}`).join('\n') +
                    `\n\nè¯·æ£€æŸ¥ CSV æ–‡ä»¶ã€‚`;
                console.error('æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å¤±è´¥:', errorMsg);
                const errorDiv = document.getElementById('error');
                errorDiv.style.display = 'block';
                errorDiv.textContent = errorMsg;
            }

            // åˆ›å»ºæ‰€æœ‰åˆ—çš„å¤é€‰æ¡†
            Object.keys(columnDefinitions).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'column-category';

                // åˆ›å»ºåˆ†ç»„æ ‡é¢˜å®¹å™¨
                const headerDiv = document.createElement('div');
                headerDiv.className = 'column-category-header';

                const h4 = document.createElement('h4');
                h4.textContent = category;
                headerDiv.appendChild(h4);

                // åˆ›å»ºåˆ†ç»„æ“ä½œæŒ‰é’®
                const categoryActions = document.createElement('div');
                categoryActions.className = 'category-actions';

                const selectAllBtn = document.createElement('button');
                selectAllBtn.textContent = 'å…¨é€‰';
                selectAllBtn.type = 'button';
                selectAllBtn.onclick = () => {
                    const categoryCheckboxes = categoryDiv.querySelectorAll('input[type="checkbox"]');
                    categoryCheckboxes.forEach(cb => cb.checked = true);
                };

                const selectNoneBtn = document.createElement('button');
                selectNoneBtn.textContent = 'å…¨ä¸é€‰';
                selectNoneBtn.type = 'button';
                selectNoneBtn.onclick = () => {
                    const categoryCheckboxes = categoryDiv.querySelectorAll('input[type="checkbox"]');
                    categoryCheckboxes.forEach(cb => cb.checked = false);
                };

                categoryActions.appendChild(selectAllBtn);
                categoryActions.appendChild(selectNoneBtn);
                headerDiv.appendChild(categoryActions);
                categoryDiv.appendChild(headerDiv);

                const checkboxesDiv = document.createElement('div');
                checkboxesDiv.className = 'column-checkboxes';

                columnDefinitions[category].forEach(col => {
                    // åªæ˜¾ç¤º CSV ä¸­å®é™…å­˜åœ¨çš„åŸºç¡€åˆ—
                    if (!allHeaders.includes(col.base)) return;
                    
                    // å¦‚æœæœ‰æ’ååˆ—ï¼Œæ£€æŸ¥æ˜¯å¦å®Œæ•´
                    if (col.hasRank && !validateColumnGroup(col.base)) {
                        return; // è·³è¿‡ä¸å®Œæ•´çš„åˆ—
                    }

                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'column-checkbox';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `col_${col.base}`;
                    checkbox.value = col.base;
                    checkbox.checked = visibleColumns.includes(col.base);

                    const label = document.createElement('label');
                    label.htmlFor = `col_${col.base}`;
                    label.textContent = col.label;

                    checkboxDiv.appendChild(checkbox);
                    checkboxDiv.appendChild(label);
                    checkboxesDiv.appendChild(checkboxDiv);
                });

                if (checkboxesDiv.children.length > 0) {
                    categoryDiv.appendChild(checkboxesDiv);
                    panel.appendChild(categoryDiv);
                }
            });

            // æ›´æ–°æ’åºä¸‹æ‹‰èœå•
            updateSortColumnSelect();
        }

        // æ›´æ–°æ’åºå­—æ®µä¸‹æ‹‰èœå•
        function updateSortColumnSelect() {
            const select = document.getElementById('sortColumn');
            const currentValue = select.value;
            select.innerHTML = '';

            // æ·»åŠ å¸¸ç”¨å­—æ®µï¼ˆä½¿ç”¨åŸºç¡€åˆ—åï¼Œä½†ä¼šæŒ‰æ’åæ’åºï¼‰
            const commonFields = [
                { base: 'best', label: 'æœ€ä½³æˆç»©' },
                { base: 'average', label: 'å¹³å‡æˆç»©' },
                { base: 'solved_mean', label: 'å•æ¬¡å¹³å‡' },
                { base: 'competitions', label: 'æ¯”èµ›æ¬¡æ•°' },
                { base: 'rounds', label: 'è½®æ¬¡' }
            ];

            commonFields.forEach(field => {
                if (allHeaders.includes(field.base)) {
                    const option = document.createElement('option');
                    option.value = field.base;
                    option.textContent = field.label + ' (æŒ‰æ’å)';
                    if (field.base === currentValue) option.selected = true;
                    select.appendChild(option);
                }
            });

            // æ·»åŠ åˆ†éš”çº¿
            if (visibleColumns.length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = 'å…¶ä»–å­—æ®µ';
                select.appendChild(optgroup);

                visibleColumns.forEach(baseCol => {
                    if (!commonFields.find(f => f.base === baseCol)) {
                        const colDef = getColumnDef(baseCol);
                        if (colDef) {
                            const option = document.createElement('option');
                            option.value = baseCol;
                            let label = colDef.label;
                            if (colDef.hasRank) label += ' (æŒ‰æ’å)';
                            option.textContent = label;
                            if (baseCol === currentValue) option.selected = true;
                            optgroup.appendChild(option);
                        }
                    }
                });
            }
        }

        // æ›´æ–°é¡µé¢æ ‡é¢˜å’Œæè¿°
        function updateHeader() {
            const config = fileConfigs[currentFile];
            if (config) {
                document.getElementById('headerDescription').textContent = config.description;
            }
        }

        // åŠ è½½ CSV æ•°æ®
        async function loadData(filename = null) {
            if (filename) {
                currentFile = filename;
                // ä¿å­˜åˆ° localStorage
                localStorage.setItem('currentFile', currentFile);
            } else {
                // ä» localStorage åŠ è½½ä¿å­˜çš„æ–‡ä»¶é€‰æ‹©
                const savedFile = localStorage.getItem('currentFile');
                if (savedFile && fileConfigs[savedFile]) {
                    currentFile = savedFile;
                    document.getElementById('fileSelect').value = currentFile;
                }
            }

            // æ›´æ–°é¡µé¢æ ‡é¢˜
            updateHeader();

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('dataTable').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';

            try {
                const response = await fetch(currentFile);
                if (!response.ok) {
                    throw new Error(`æ–‡ä»¶ ${currentFile} ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®`);
                }

                const text = await response.text();
                const lines = text.trim().split('\n');
                if (lines.length < 2) {
                    throw new Error('CSV æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–ä¸ºç©º');
                }

                allHeaders = parseCSVLine(lines[0]);

                allData = lines.slice(1).map(line => {
                    const values = parseCSVLine(line);
                    const row = {};
                    allHeaders.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    return row;
                });

                filteredData = [...allData];

                // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                currentPage = 1;

                // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
                document.getElementById('error').style.display = 'none';

                // é‡æ–°åˆå§‹åŒ–åˆ—é€‰æ‹©å™¨ï¼ˆå› ä¸ºä¸åŒæ–‡ä»¶çš„åˆ—å¯èƒ½ä¸åŒï¼‰
                initColumnSelector();
                updateStats();
                renderTable();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';
                document.getElementById('pagination').style.display = 'flex';
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'åŠ è½½æ•°æ®å¤±è´¥: ' + error.message;
                console.error('åŠ è½½æ•°æ®é”™è¯¯:', error);
            }
        }

        // è§£æ CSV è¡Œï¼ˆå¤„ç†å¼•å·å†…çš„é€—å·ï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // æ›´æ–°ç»Ÿè®¡æ‘˜è¦
        function updateStats() {
            const validData = filteredData.filter(d => d.best && !isNaN(parseFloat(d.best)));
            const bestValues = validData.map(d => parseFloat(d.best));
            const avgValues = validData.filter(d => d.average && !isNaN(parseFloat(d.average)))
                .map(d => parseFloat(d.average));
            const competitions = validData.reduce((sum, d) => sum + (parseInt(d.competitions) || 0), 0);

            document.getElementById('totalPlayers').textContent = filteredData.length;
            document.getElementById('avgBest').textContent = bestValues.length > 0
                ? (bestValues.reduce((a, b) => a + b, 0) / bestValues.length).toFixed(2)
                : '-';
            document.getElementById('avgAverage').textContent = avgValues.length > 0
                ? (avgValues.reduce((a, b) => a + b, 0) / avgValues.length).toFixed(2)
                : '-';
            document.getElementById('totalCompetitions').textContent = competitions;
        }

        // æ’åºæ•°æ®ï¼ˆé»˜è®¤ä½¿ç”¨æ’ååˆ—ï¼‰
        function sortData() {
            // è·å–å®é™…ç”¨äºæ’åºçš„åˆ—ï¼ˆä¼˜å…ˆä½¿ç”¨æ’ååˆ—ï¼‰
            const actualSortCol = getSortColumn(sortColumn);
            
            filteredData.sort((a, b) => {
                let valA = a[actualSortCol];
                let valB = b[actualSortCol];

                // å¤„ç†æ•°å­—
                if (!isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB))) {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                }

                if (valA === '' || valA === null || valA === 'NaN') return 1;
                if (valB === '' || valB === null || valB === 'NaN') return -1;

                let comparison = 0;
                if (valA < valB) comparison = -1;
                if (valA > valB) comparison = 1;

                return sortOrder === 'asc' ? comparison : -comparison;
            });
        }

        // è·å–åˆ—çš„æ˜¾ç¤ºåç§°
        function getColumnLabel(baseCol) {
            for (const category of Object.values(columnDefinitions)) {
                const col = category.find(c => c.base === baseCol);
                if (col) return col.label;
            }
            return baseCol;
        }
        
        // è·å–åˆ—å®šä¹‰
        function getColumnDef(baseCol) {
            for (const category of Object.values(columnDefinitions)) {
                const col = category.find(c => c.base === baseCol);
                if (col) return col;
            }
            return null;
        }
        
        // è·å–æ’åºåˆ—ï¼ˆé»˜è®¤ä½¿ç”¨æ’ååˆ—ï¼‰
        function getSortColumn(baseCol) {
            const colDef = getColumnDef(baseCol);
            if (colDef && colDef.hasRank && allHeaders.includes(baseCol + '_rank')) {
                return baseCol + '_rank';
            }
            return baseCol;
        }

        // åˆ¤æ–­åˆ—æ˜¯å¦ä¸ºæ•°å­—ç±»å‹
        function isNumberColumn(key) {
            return key !== 'personName' && key !== 'personId' && key !== 'countryId' && key !== 'gender';
        }

        // åˆ¤æ–­åˆ—æ˜¯å¦ä¸ºæ’åç±»å‹
        function isRankColumn(key) {
            return key.endsWith('_rank') || key.endsWith('_nr');
        }

        // åˆ¤æ–­åˆ—æ˜¯å¦ä¸ºå¥–ç‰Œç±»å‹
        function isMedalColumn(key) {
            return key === 'gold' || key === 'silver' || key === 'bronze';
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            sortData();

            const thead = document.querySelector('#dataTable thead tr');
            const tbody = document.getElementById('tableBody');

            // æ¸²æŸ“è¡¨å¤´
            thead.innerHTML = '';
            visibleColumns.forEach(baseCol => {
                const colDef = getColumnDef(baseCol);
                const th = document.createElement('th');
                th.className = 'sortable';
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºæ•°å­—åˆ—
                if (baseCol !== 'personName' && baseCol !== 'personId' && baseCol !== 'countryId' && baseCol !== 'gender') {
                    th.className += ' number';
                }
                
                // è®¾ç½®æ’åºåˆ—ï¼ˆé»˜è®¤ä½¿ç”¨æ’ååˆ—ï¼‰
                const sortCol = getSortColumn(baseCol);
                th.dataset.column = sortCol;
                th.dataset.baseColumn = baseCol;
                
                // æ˜¾ç¤ºåˆ—å
                let label = getColumnLabel(baseCol);
                if (colDef && colDef.hasRank && showRanks) {
                    label += ' (å«æ’å)';
                }
                th.textContent = label;
                thead.appendChild(th);
            });

            // æ¸²æŸ“è¡¨æ ¼å†…å®¹
            tbody.innerHTML = '';

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            const formatNumber = (val, isInteger = false) => {
                if (!val || val === '' || val === 'NaN') return '-';
                const num = parseFloat(val);
                if (isNaN(num)) return val;
                return isInteger ? Math.round(num).toString() : num.toFixed(2);
            };

            const formatInteger = (val) => {
                if (!val || val === '' || val === 'NaN') return '-';
                const num = parseFloat(val);
                return isNaN(num) ? val : Math.round(num).toString();
            };

            pageData.forEach((row) => {
                const tr = document.createElement('tr');

                visibleColumns.forEach(baseCol => {
                    const colDef = getColumnDef(baseCol);
                    const td = document.createElement('td');
                    
                    // è·å–åŸºç¡€å€¼
                    let baseValue = row[baseCol] || '-';
                    
                    // åˆ¤æ–­æ˜¯å¦ä¸ºæ•´æ•°åˆ—
                    const isIntegerCol = colDef && colDef.isInteger === true;
                    
                    // å¦‚æœæœ‰æ’ååˆ—ä¸”æ˜¾ç¤ºæ’åå¼€å…³æ‰“å¼€ï¼Œåˆå¹¶æ˜¾ç¤º
                    if (colDef && colDef.hasRank && showRanks) {
                        const rankCol = baseCol + '_rank';
                        const nrCol = baseCol + '_nr';
                        const rankValue = row[rankCol] || '-';
                        const nrValue = row[nrCol] || '-';
                        
                        // æ ¼å¼åŒ–æ˜¾ç¤ºï¼šåŸºç¡€å€¼ (å…¨çƒæ’å/å›½å®¶æ’å)
                        let displayValue = baseValue;
                        if (baseValue !== '-') {
                            if (baseCol !== 'personName' && baseCol !== 'personId' && baseCol !== 'countryId' && baseCol !== 'gender') {
                                displayValue = formatNumber(baseValue, isIntegerCol);
                            }
                        }
                        
                        td.className = 'number';
                        if (isMedalColumn(baseCol)) {
                            if (baseCol === 'gold') td.className += ' medal-gold';
                            else if (baseCol === 'silver') td.className += ' medal-silver';
                            else if (baseCol === 'bronze') td.className += ' medal-bronze';
                        }
                        
                        // åˆ›å»ºåŒ…å«æ’åä¿¡æ¯çš„æ˜¾ç¤º
                        const mainSpan = document.createElement('span');
                        mainSpan.textContent = displayValue;
                        td.appendChild(mainSpan);
                        
                        if (rankValue !== '-' || nrValue !== '-') {
                            const rankInfo = document.createElement('span');
                            rankInfo.className = 'rank-info';
                            const rankStr = rankValue !== '-' ? formatInteger(rankValue) : '-';
                            const nrStr = nrValue !== '-' ? formatInteger(nrValue) : '-';
                            rankInfo.innerHTML = ` (<span class="rank-value">${rankStr}</span>/<span class="rank-value">${nrStr}</span>)`;
                            td.appendChild(rankInfo);
                        } else {
                            td.textContent = displayValue;
                        }
                    } else {
                        // ä¸æ˜¾ç¤ºæ’åï¼Œåªæ˜¾ç¤ºåŸºç¡€å€¼
                        if (baseCol !== 'personName' && baseCol !== 'personId' && baseCol !== 'countryId' && baseCol !== 'gender') {
                            td.className = 'number';
                            if (isMedalColumn(baseCol)) {
                                if (baseCol === 'gold') td.className += ' medal-gold';
                                else if (baseCol === 'silver') td.className += ' medal-silver';
                                else if (baseCol === 'bronze') td.className += ' medal-bronze';
                                baseValue = formatInteger(baseValue);
                            } else {
                                baseValue = formatNumber(baseValue, isIntegerCol);
                            }
                        }
                        td.textContent = baseValue;
                    }

                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            document.getElementById('pageInfo').textContent =
                `ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ (å…± ${filteredData.length} æ¡è®°å½•)`;

            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;

            // æ›´æ–°è¡¨å¤´æ’åºæŒ‡ç¤ºå™¨å’Œäº‹ä»¶
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                const baseCol = th.dataset.baseColumn;
                if (baseCol === sortColumn) {
                    th.classList.add(sortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
                }

                // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                th.onclick = () => {
                    const baseCol = th.dataset.baseColumn;
                    if (sortColumn === baseCol) {
                        sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = baseCol; // ä¿å­˜åŸºç¡€åˆ—å
                        sortOrder = 'asc';
                    }
                    renderTable();
                };
            });
        }

        // æœç´¢åŠŸèƒ½
        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            filteredData = allData.filter(row => {
                const name = (row.personName || '').toLowerCase();
                return name.includes(searchTerm);
            });
            currentPage = 1;
            updateStats();
            renderTable();
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('fileSelect').addEventListener('change', (e) => {
            loadData(e.target.value);
        });

        document.getElementById('showRanks').addEventListener('change', (e) => {
            showRanks = e.target.checked;
            localStorage.setItem('showRanks', showRanks);
            renderTable();
        });

        // åŠ è½½æ˜¾ç¤ºæ’åè®¾ç½®
        const savedShowRanks = localStorage.getItem('showRanks');
        if (savedShowRanks !== null) {
            showRanks = savedShowRanks === 'true';
            document.getElementById('showRanks').checked = showRanks;
        }

        document.getElementById('sortColumn').addEventListener('change', (e) => {
            sortColumn = e.target.value;
            renderTable();
        });

        document.getElementById('sortOrder').addEventListener('change', (e) => {
            sortOrder = e.target.value;
            renderTable();
        });

        document.getElementById('searchInput').addEventListener('input', filterData);

        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        // åˆ—é€‰æ‹©å™¨äº‹ä»¶
        document.getElementById('columnSelectorBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            const panel = document.getElementById('columnSelectorPanel');
            panel.classList.toggle('show');
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­é¢æ¿
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('columnSelectorPanel');
            const btn = document.getElementById('columnSelectorBtn');
            if (!panel.contains(e.target) && e.target !== btn) {
                panel.classList.remove('show');
            }
        });

        document.getElementById('selectAllBtn').addEventListener('click', () => {
            document.querySelectorAll('#columnCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
        });

        document.getElementById('selectNoneBtn').addEventListener('click', () => {
            document.querySelectorAll('#columnCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        });

        document.getElementById('selectDefaultBtn').addEventListener('click', () => {
            document.querySelectorAll('#columnCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = defaultColumns.includes(cb.value);
            });
        });

        document.getElementById('applyColumnsBtn').addEventListener('click', () => {
            visibleColumns = [];
            document.querySelectorAll('#columnCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                visibleColumns.push(cb.value);
            });

            // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªåˆ—è¢«é€‰ä¸­
            if (visibleColumns.length === 0) {
                const defaultCol = allHeaders.includes('personName') ? 'personName' : allHeaders[0];
                visibleColumns = [defaultCol];
                alert('è‡³å°‘éœ€è¦é€‰æ‹©ä¸€ä¸ªåˆ—ï¼å·²è‡ªåŠ¨é€‰æ‹©é»˜è®¤åˆ—ã€‚');
            }

            // ä¿å­˜åˆ° localStorageï¼ˆæŒ‰æ–‡ä»¶åˆ†åˆ«ä¿å­˜ï¼‰
            const savedColumnsKey = `visibleColumns_${currentFile}`;
            localStorage.setItem(savedColumnsKey, JSON.stringify(visibleColumns));

            // å…³é—­é¢æ¿
            document.getElementById('columnSelectorPanel').classList.remove('show');

            // æ›´æ–°æ’åºä¸‹æ‹‰èœå•
            updateSortColumnSelect();

            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            currentPage = 1;
            renderTable();
        });

        // åˆå§‹åŒ–
        loadData();
    </script>
</body>
</html>
